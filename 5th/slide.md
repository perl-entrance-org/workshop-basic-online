# Perl 入学式

### 第 5 回 ハッシュの操作 / サブルーチン

---

## 諸注意

- 講義中の疑問点は Discord で質問して下さい。サポーターが適宜回答やアドバイスを行える様にスタンバイしています。

- うまくプログラムが動かない、分からない時は Discord #講義部屋 でサポーターにヘルプを要請してください。Discord のテキスト及び音声チャットにて個別にサポートします。

- <a href="https://discord.com/" target="_blank">Discord | 会話や交流が楽しめるプラットフォーム</a>

---

## 今日の流れ

- ハッシュの操作

- サブルーチン

---

# ハッシュの操作

---

## ハッシュの操作

### keys, delete, exists

ハッシュを便利に扱うための関数について説明します。

- keys

  - ハッシュの名前（key）の集合を返す。

- delete

  - ハッシュの要素を削除する。

- exists
  - ハッシュの要素が存在するかしないかを返す。

---

## ハッシュの操作

### keys

`keys` 関数はハッシュの名前（key）を配列にして返します。

```perl
my %hash = (
    name  => 'Larry',
    birth => 1954,
    lang  => 'Perl',
);
my @keys = keys %hash;
print "@keys\n";    # birth name lang （順不同）
```

ただし、この `keys` は名前（key）を **順不同、順番が不定** で返します。

ハッシュに書かれた順番で返ってくるとは限りません。

---

## ハッシュの操作

### 名前（key）を決まった順番で受け取る

名前（key）を同じ順番で受け取りたい場合は、 `sort` 関数を使って並び替えます。

```perl
my %hash = (
    name  => 'Larry',
    birth => 1954,
    lang  => 'Perl',
);
my @keys = keys %hash;      # この時点では順不同
my @sorted = sort @keys;    # sort で並び替える
print "@sorted\n";            # birth lang name （常にこの順番）
```

---

## ハッシュの操作

### 名前（key）を決まった順番で受け取る

値のみを順不同で受け取る `values` 関数もありますが、Perl 入学式のカリキュラムでは使いません。

[Perl 入門ゼミ values 関数 - ハッシュのすべての値の取得](https://tutorial.perlzemi.com/blog/20100222126425.html)

---

## 練習問題(hash_keys.pl)

次のハッシュの key を全て取り出して、画面に出力してみよう。

```perl
#!/usr/bin/env perl
use strict;
use warnings;

my %users = (
    'Alice'  => 1,
    'Bob'    => 2,
    'Carol'  => 3,
    'Daiana' => 4,
);
```

---

## 出来た方は、Discord のテキストチャットで「出来た！」とリアクションお願いします！

---

## ハッシュの操作

### delete

`delete` 関数は、指定したハッシュの名前（key）と、それに対応する値（value）を削除します。

```perl
my %hash = (
    name  => 'Larry',
    birth => 1954,
    lang  => 'Perl',
);
delete $hash{lang};     # lang という名前（key）を指定して削除
print "$hash{lang}\n";  # Use of uninitialized value ... 警告が表示される
```

---

## ハッシュの操作

### delete

この例では、最後の行で削除した名前（key）に対応する値（value）を表示しようとしています。

このとき、しっかり「おまじない」を書いていれば、存在しないキーを print しようとしている、と警告してくれます。

---

## ハッシュの操作

### exists

`exists` 関数は、指定したハッシュの名前（key）が存在するか確認します。

```perl
my %hash = (
    name  => 'Larry',
);
if ( exists $hash{name} ) { print "exists\n" }    # exists
if ( exists $hash{foo} )  { print "exists\n" }    # 何も出てこない
```

- 名前（key）が存在すれば `1`（真）を返します。

- 名前（key）が存在しなければ `' '`(空文字、偽)を返します。

---

## 練習問題(menu.pl)

次のハッシュはカフェのメニュー一覧を表しています。

1. `icecream` のメニューを削除してみよう。

2. `icecream` のメニューが削除されていれば、"夏期メニューは終了しました"と画面に表示してみよう。

```perl
#!/usr/bin/env perl
use strict;
use warnings;

my %menu = (
    'coffee'   => 380,
    'icecream' => 200,
    'salad'    => 600,
    'cake'     => 400,
);
```

---

## 出来た方は、Discord のテキストチャットで「出来た！」とリアクションお願いします！

---

## ハッシュの操作

### 添字には変数が利用可能

ハッシュの名前（key）は文字列が入ったスカラー変数でも指定可能です。

```perl
my %hash = (
    name  => 'Larry',
    birth => 1954,
    lang  => 'Perl',
);
my $key = 'lang';
print $hash{$key};    # Perl
```

- `{foo}` であれば foo という文字列が名前（key）となります。

- `{$foo}` であればスカラー変数 `$foo` に代入された文字列が名前（key）となります。

---

## ハッシュの操作

### ハッシュのすべての要素を処理する

`keys` 関数は配列を返します。これを for 文と組み合わせて、ハッシュのすべての要素を処理することができます。

```perl
my %hash = (
    name  => 'Larry',
    birth => 1954,
    lang  => 'Perl',
);

for my $key ( keys %hash ) {
    my $value = $hash{$key};
    print "$key is $value\n";
}
```

どのような結果になるでしょうか？

---

## 練習問題（menu_print.pl）

以下のハッシュをコピペして利用してください。ハッシュのデータを全て `"<<商品名>> の価格は <<金額>> 円です。"` の形式で出力してみよう。

出力する順番は商品名を ABC 順(昇順)で出力しよう。また、1 品目毎に改行して見やすく出力しよう。

```perl
#!/usr/bin/env perl
use strict;
use warnings;

my %menu = (
    'coffee'   => 380,
    'tea'      => 380,
    'sandwich' => 800,
    'icecream' => 200,
    'salada'   => 600,
    'cake'     => 400,
);
```

---

## 出来た方は、Discord のテキストチャットで「出来た！」とリアクションお願いします！

---

## 練習問題（hash_func.pl）

以下のハッシュをコピペして利用してください。

```perl
my %hash = (
    name  => 'Larry',
    birth => 1954,
    lang  => 'Perl',
);
```

1. ハッシュに以下の要素を追加してください。
   - 名前（key）: software
   - 値（value）: patch

---

## 練習問題（hash_func.pl）

以下のハッシュをコピペして利用してください。

2. `keys` 関数を使って, `%hash` の名前（key）をすべて出力してください。

3. `delete` 関数を使って, 1 で使ったハッシュから birth の要素を削除してください。

---

## 練習問題（hash_func2.pl）

１つ前の練習問題で作成した `hash_func.pl` を利用します。

`exists` 関数を使って、`name`, `birth`, `lang`, `software` の各要素が存在するか確認してください。`名前（key）`は各要素の key 名が入るものとします。

- 存在している場合は `名前（key） is exist.` と表示する。

- 存在しない場合は `名前（key） is not exist.` と表示しする。

---

## 出来た方は、Discord のテキストチャットで「出来た！」とリアクションお願いします！

---

# サブルーチン

---

## サブルーチン

### サブルーチンとは?

プログラムの中で、意味や内容がまとまっている作業をひとかたまりにしたものを **サブルーチン** と呼びます。

Perl におけるサブルーチンは、「関数」とほぼ同義です。

---

## サブルーチン

### サブルーチンと組み込み関数

Perl には、これまで使ってきた `print` や `join` など、Perl が提供する関数(組み込み関数)が用意されています。

サブルーチンを使うことで、 `print` や `join` のように、「特定の処理を行うプログラム」をひとかたまりにして、 簡単に呼ぶことが出来るようになります。

---

## サブルーチン

### サブルーチンの定義

それでは、早速サブルーチンを定義していきましょう。

今回は、末尾に自動的に改行(`\n`)を付与しながら文字列を表示する `say` というサブルーチンを定義してみます。

---

## サブルーチン

### サブルーチンの定義

```perl
sub say {               # -┐
    my $str = shift @_; #  │ サブルーチン say を
    print "$str\n";     #  │ 定義しているところ
}                       # -┘
say("hello, world!"); # hello, world!
```

Perl でサブルーチンを定義する為には、以下のように書きます。

定義時に末尾に `;` は不要です。

```perl
sub サブルーチン名 { ... }
```

それでは、詳しく見て行きましょう。

---

## サブルーチン

### サブルーチンの命名規則

```perl
sub say { ... }
```

- サブルーチン名として使える文字は以下です。

  - 大文字・小文字の英数字
  - アンダースコア(`_`)

- ただし、サブルーチン名の先頭文字には以下の制限があります。
  - 英文字
  - `_`

これは変数名と同じルールです。

---

## サブルーチン

### Perl におけるサブルーチンの命名規則

```perl
sub say_hello_world { ... }

sub say_good_morning { ... }
```

複数の単語でサブルーチン名を構築する時は、このように単語間を `_` で繋げる場合が多いです。

このような `_` で単語をつなげる記法をスネークケース（snake_case）といいます。

Perl では基本的にスネークケースを推奨しています。

---

## サブルーチン

### サブルーチン命名規則クイズ

```perl
sub hoge!    { ... }

sub _hoge    { ... }

sub 123_hoge    { ... }

sub hoge_123 { ... }
```

この中で、サブルーチン名として正しいものはどれでしょうか？

---

## サブルーチン

### サブルーチン命名規則クイズの正解

```perl
sub hoge!    { ... }    # 記号 '!' はサブルーチン名に使えない

sub _hoge    { ... }

sub 123_hoge    { ... } # 先頭は 英字 or '_' のみ
                        # 数字は先頭に使えない
sub hoge_123 { ... }
```

正解は `_hoge` と `hoge_123` です。

---

## サブルーチン

### サブルーチンの呼び出し

```perl
say();
```

定義したサブルーチンは、定義したサブルーチン名の後ろに `()` を付けることで利用できます。

行末に書く場合には、 `;` が必要です。

このようにサブルーチンを利用することを「**サブルーチンの呼び出し**」といいます。

---

## サブルーチン

### サブルーチンの呼び出し

```perl
say('Hello Perl!');
```

サブルーチンに値(引数)を渡したい場合、 `()` の中に書きます。

`()` を使わずに, サブルーチン名の先頭に `&` を付けて `&say` という書き方で呼びだすこともできますが、古い書き方なので使わないようにしましょう。

---

## 練習問題（subroutine.pl）

- 以下に書かれた Perl プログラムをコピペして、すでに定義されたサブルーチン `notice_event` を呼び出してみよう。

- すでに定義されたサブルーチン `greeting` に引数として自分のニックネームを渡して呼び出してみよう。

```perl
sub notice_event {
    print "2月18日(木), 19日(金)の17:00から\n";
    print "PerlのイベントJapan.pmがオンラインで開催されます!\n";
}

sub greeting {
    my $name = shift;
    print "$name さん、Perl入学式へようこそ!\n";
}

```

---

## 出来た方は、Discord のテキストチャットで「出来た！」とリアクションお願いします！

---

## サブルーチン

### サブルーチンの引数

```perl
sub say {
    my $str = shift @_; # ←┐
    print "$str\n";     #  │ サブルーチンの引数 'Hello Perl' は
}                       #  │ @_ という配列に格納される
                        #  │
say('Hello Perl');      # ─┘
```

サブルーチンに与えられた引数は、 `@_` という配列に格納されます。

2 行目では、`shift` を使って、この　`@_` の先頭の要素を取得しています。

このサブルーチンを `say('hoge');` のように呼んだ場合、 `@_` の中身は`('hoge')` となり、 `$str` には `hoge` という文字列が入ります。

---

## サブルーチン

### サブルーチンの引数

```perl
sub say {
    my $str = shift;  # @_ が省略されている
    print "$str\n";
}

say('Hello Perl');    # Hello Perl
```

`@_` は、省略することができます。

その為、2 行目の `my $str = shift;` は、 `my $str = shift @_;` と同じ意味になります。

---

## サブルーチン

### サブルーチンの位置

```perl
say('Hello Perl');  # Hello Perl

sub say {
    my $str = shift;
    print "$str\n";
}
```

同じファイル内であれば、サブルーチンの位置にかかわらず `say('hoge');` として呼び出すことができます。

ファイル末尾にサブルーチンがまとまっている方が見やすい場合は、このスタイルで書きましょう。

---

## サブルーチン

### サブルーチン「add」を作る

```perl
sub add {                     # ┐
    my ($left, $right) = @_;  # │サブルーチン add の定義部
    return $left + $right;    # │
}                             # ┘

my $result = add(2, 5);       # サブルーチン add の呼び出し
print $result . "\n";   # 7
```

次に、2 つの引数を受け取り、その和を返すサブルーチン `add` を考えてみることにします。

`add` サブルーチンの定義と呼び出しは、このように書くことができます。

---

## 練習問題（call_subroutine.pl）

- 呼び出すと画面に `サブルーチンが呼び出されました` と表示されるサブルーチン `call_subroutine` を定義してみよう。そして呼び出すプログラムを書いてみましょう。

- 引数で渡した文字列をそのまま画面に出力するサブルーチン `echo` を定義してみましょう。そして呼び出すプログラムを書いてみましょう。

---

## 出来た方は、Discord のテキストチャットで「出来た！」とリアクションお願いします！

---

## サブルーチン

### サブルーチンに複数の引数を渡す

```perl
sub add {
    my ($left, $right) = @_;  # @_ の中に 2, 5が入る
    return $left + $right;    # ↑
}                             # │
                              # │
my $result = add(2, 5);       # ┘ add の引数 2, 5
print $result . "\n";   # 7
```

サブルーチンに複数の引数が与えられた場合(この場合は `2` と `5` )、サブルーチン側ではこのようにして受け取ることができます。

サブルーチンに複数の引数を与える時は、`( )` の中で配列のようにカンマ　`,` で区切って渡します。

---

## サブルーチン

### サブルーチン側の引数の受け取り方

```perl
sub add {
                        # @_ を省略した場合
    my $left  = shift;  # @_ の先頭から1つ取り出して変数に入れている
    my $right = shift;  # @_ の先頭から1つ取り出して変数に入れている
    return $left + $right;
}
my $result = add(2, 5);
```

```perl
sub add {
    my $left  = $_[0];  # $_[0] : @_ の最初の要素
    my $right = $_[1];  # $_[1] : @_ の次の要素
    return $left + $right;
}
my $result = add(2, 5);
```

先程の引数の受け取り方は、上記のプログラムと同じ意味になります。

---

## サブルーチン

### 返り値と return

```perl
sub add {
    my ($left, $right) = @_;
    return $left + $right;  # $left + $right の結果を返す
}
my $result = add(2, 5);
print $result . "\n";   # 7
```

サブルーチンは, `return` を使うことで、任意のデータを呼び出し元へ返すことができます。

サブルーチンや関数の処理結果のことを **<ruby>返り値<rt>かえりち</rt></ruby>** といいます。

この場合、 `$left + $right` の計算結果が呼び出し元へ返され、 `$result` に格納されます。

---

## 練習問題（add_brackets.pl）

- 引数で渡した文字列の先頭に `(` 、末尾に `)` を付け加えて返り値で戻すサブルーチン `add_brackets` を定義してみましょう。そして呼び出すプログラムを書いてみましょう。

- 例：引数に `Perl` を渡すと `(Perl)` になる。

---

## 出来た方は、Discord のテキストチャットで「出来た！」とリアクションお願いします！

---

## サブルーチン

### 複数の return

```perl
sub is_same {
    my ( $left, $right ) = @_;
    if ( $left eq $right ) {
        print "true\n";    # $left と $right が等しければ表示
        return 1;
    }
    else {
        print "false\n";    # $left と $right が異なれば表示
        return 0;
    }
    print "YOU WILL NEVER SEE IT\n"; # 絶対に表示されない!
    return;
}
```

`return`に到達した場合、それ以降の処理は一切行われず、すぐさま値を返してサブルーチンの実行を終了します。（ガード節といいます）

---

## サブルーチン

### 複数の返り値

```perl
sub add_and_min {
    my ( $left, $right ) = @_;
    return ( $left + $right, $left - $right );
}
my ( $add, $min ) = add_and_min( 5, 4 );
```

サブルーチンは、このようにリストを返すことで複数個の値を返すこともできます。

引数がどのようにサブルーチンに渡されて処理されるか、追ってみましょう。

---

## 練習問題（return_numbers.pl）

- 引数で渡した 1 つの数字に対して、3 つの数字のリストを返り値として戻すサブルーチンを定義しましょう。リストの最初の数は引数で渡された数より 2 少ない数、リストの 2 番目の数は渡された数、リスト 3 番目の数は渡された数より 2 多い数としてください。(例) 引数で `3` が渡される -> `(1, 3, 5)` のリストが返り値となる)

- そして呼び出すプログラムを書いてみましょう。

---

## 出来た方は、Discord のテキストチャットで「出来た！」とリアクションお願いします！

---

## サブルーチン

## return がない場合の返り値

```perl
sub add {
    my ($left, $right) = @_;
    $left + $right;         # サブルーチンの中で最後に評価された行
}

my $result = add(2, 5);
print $result . "\n";   # 7
```

サブルーチンの中に `return` がない場合、サブルーチンの返り値は最後に評価された処理の結果(この場合、 `$left + $right`の計算結果)を返します。

値を返すという意図を明確にするため、 `return` は書くようにしましょう。

---

## 練習問題

次のようなサブルーチンを持つプログラムを `simple_calc.pl` という名前で作成しよう。

- 2 つの引数の和（足し算）を計算する `add`
- 2 つの引数の差（引き算）を計算する `min`
- 2 つの引数の積（掛け算）を計算する `mul`
- 2 つの引数の商（割り算）を計算する `div`

---

## 練習問題

これらのサブルーチンが正しく実装できているか(与えた 2 つの引数に対して, 適切な値を返すか)を確認するプログラムも一緒に書くこと。

- 時間の余った人は「0」で割った際のエラーを回避する仕組みを入れてみよう

- さらに時間の余った人はコマンドライン引数から 2 つの数字を受け取り計算する仕組みをいれてみよう

---

## 出来た方は、Discord のテキストチャットで「出来た！」とリアクションお願いします！

---

## お疲れ様でした!

Perl 入学式オンライン版の参加、ありがとうございました。

これで 2020 年度のオンライン版講義は終了となります。

是非 Perl 入学式の Discord #雑談部屋 でサポーターや参加者の皆さんと交流しましょう。

不明点も Discord #雑談部屋 で是非質問してください。
